<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <script src="scripts/jquery-1.11.2.js"></script>
    <script src="scripts/bootstrap.js"></script>
    <script src="scripts/knockout-3.2.0.js"></script>
    <script src="scripts/knockout.mapping-latest.js"></script>
    <script src="scripts/Site.js"></script>
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/bootstrap-theme.css" rel="stylesheet" />
    <link href="Site.css" rel="stylesheet" />
    <title>Animal Edit</title>
</head>
<body>
    <form method="post" action="peteditko?id=1" id="form1">
    <div>
        
     <div id="divMain" class="container">
        <div class="row">
            <span class="col-lg-1 heading">Edit Pet</span>
        </div>
        <div class="row">
            <span class="col-lg-2 span4"><a class="lnk" href="AnimalList.html">Return to Pet List</a></span>
        </div>
        <p />
        <div class="row ent">
            <span class="col-lg-1">ID:</span>
            <span class="col-lg-1"><span id="lblPetID" data-bind="text:petid" /></span>
        </div>
        <div class="row ent">
            <span class="col-lg-1">Name:</span>        
            <span class="col-lg-1"><input type="text" id="Text1" data-bind="value:petname" style="width:300px;" maxlength="80"/></span>
        </div>
        <div class="row ent">
            <span class="col-lg-1">Type:</span>
            <span class="col-lg-1"><input type="text" id="Text2a" data-bind="value:pettype" /></span>
        </div>
        <div class="row ent">
            <span class="col-lg-1">Breed:</span>
            <span class="col-lg-1"><input type="text" id="Text4" data-bind="value: breed" /></span>
        </div>
        <div class="row ent">
            <span class="col-lg-1">Color:</span>
            <span class="col-lg-1"><input type="text" id="Text5" data-bind="value:color" /></span>
        </div>
        <div class="row ent">
            <span class="col-lg-1">weight:</span>
            <span class="col-lg-1"><input type="text" id="Text2" data-bind="value:weight" /></span>
        </div>
        <div class="row ent">
            <span class="col-lg-1">Notes:</span>
            <span class="col-lg-3"><textarea id="Text3" data-bind="textInput:notes"  style="width:400px;height:100px;"></textarea></span>
        </div>
        <p/>
        <div class="row ent">
            <span class="col-lg-1">&#0160;</span>
            <span class="col-lg-1"><input type="button" value="Save" onclick="saveRecord()" /></span>
        </div>
        <p/>
        <div class="row ent">
            <span class="col-lg-1">&#0160;</span>
            <span class="col-lg-1"><input type="button" value="Delete" onclick="deleteRecord()" /></span>
        </div>
        <div class="row">
            <span class="col-lg-1">&#0160;</span>
            <div class="col-lg-6 msg"><div id="divMessage"></div></div>
        </div>
    </div>

    <script type="text/javascript">
        // MSI developer code
        var devCode = "9ofioftnebd1xr7k0nnwcwwt4st3pbpb";
        // MSI API root URL
        var MSIRootAPI = "https://msitest.azurewebsites.net/dapi/9ofioftnebd1xr7k0nnwcwwt4st3pbpb/";
        var id = 0;

        jQuery(document).ready(function () {
            // retrieve is param
            //if ($.QueryString["id"]!=null){
            id = jQuery.QueryString["id"];
            //}
            // check for valid id or hide entry fields
            if (id == null || id.length == 0) {
                $("#divMessage").text("Record ID not set");
                $(".ent").hide();
                return;
            }
            //var viewModel = new pet();
            if (id > 0) {
                getData();
            } else {
                viewModel = new pet();
                ko.applyBindings(viewModel);
            }
        })

        // call MSI web service to pull single record based on id
        function getData() 
        {
            var url = MSIRootAPI + "pet/" + id;
            var jqxhr = $.get(MSIRootAPI + "pet/" + id, "", function (response) 
            {
                getDataResponse(response);
            }, "json")
            .fail(function (response) 
            {
                RequestFailed(response);
            }
            )
        };

        function RequestFailed(r) {
            alert("AJAX data request failed from within edit");
        }

        function viewModel(data) {
            var self = this;
            self.petid = ko.observable();
            self.pettype = ko.observable();
            self.petname = ko.observable();
            self.weight = ko.observable();
            self.breed = ko.observable();
            self.color = ko.observable();
            self.notes = ko.observable();
        }

        // populate HTML controls from single record
        function getDataResponse(response) 
        {
            clearMessage();
            try 
            {
                viewModel = new pet(response);
                ko.applyBindings(viewModel);
            } 
            catch (e) 
            { 
                alert("get data error: " + e.message); 
            }
        }

        // send form data back to web service
        function saveRecord() {
            clearMessage();
            sendData()
        }

        // JSON object for pet
        function pet(data) {
            var self = this;
            if (data != null) {
                self.petid = data.petid;
                self.pettype = data.pettype;
                self.petname = data.petname;
                self.weight = data.weight;
                self.breed = data.breed;
                self.color = data.color;
                self.notes = data.notes;
            } else {
                self.petid = 0;
                self.pettype = "";
                self.petname = "new pet";
                self.weight = 0.0;
                self.breed = "";
                self.color = "";
                self.notes = "";
            }
        }

        // send pet record to web service for insert or update
        function sendData() {
            //alert("send: id=" + viewModel.petid);
            var jvnd = JSON.stringify(viewModel);
            jQuery.ajax({
                url: MSIRootAPI + "pet",
                type: "Post",
                data: jvnd,
                processData: true,
                contentType: "application/json",
                dataType: "json",
                success: function (result) {
                    processUpdateResult(result);
                },
                error: function (result) { setMessage("update (post) failed: " + result); }
            });
        }

        // process update record returned from server
        function processUpdateResult(response) {
            if (response.successful) {
                if (response.action == "insert") {
                    jQuery("#lblPetID").text(response.newrecordid);
                }
            } else {
            }
            setMessage(response.message);
        }

        // delete record: uses HTTP DELETE 
        function deleteRecord() {
            clearMessage();
            var reply = confirm("Delete pet record " + id + "?")
            if (reply) {
                jQuery.ajax({
                    url: MSIRootAPI + "pet/" + id,
                    type: "Delete",
                    processData: true,
                    contentType: "application/json",
                    dataType: "json",
                    success: function (response) {
                        setMessage(response.message);
                        alert("Record was deleted");
                        location.href = "AnimalList.html";
                    },
                    error: function (result) { setMessage("delete failed: " + result); }
                });
            }
        }
        // clear page message
        function clearMessage() {
            jQuery("#divMessage").text("");
        }
        // set page message/error
        function setMessage(msg) {
            jQuery("#divMessage").text(msg);
        }
    </script>

    </div>
    </form>
    <footer class="footer"> <p>Except as otherwise noted, the content of this page is licensed under the <br />
       Creative Commons Attribution 3.0 License and the Apache 2.0 License. See Site Policies for details.
</p></footer>
</body>
</html>
